syntax = "proto3";

package CoreScript;

service CoreScriptRunner {
  rpc ExecuteScript (ExecuteScriptRequest) returns (ExecuteScriptResponse);
  rpc GetStatus (GetStatusRequest) returns (GetStatusResponse);
  rpc GetScriptMetadata (GetScriptMetadataRequest) returns (GetScriptMetadataResponse);
  rpc GetScriptParameters (GetScriptParametersRequest) returns (GetScriptParametersResponse);
  rpc GetCombinedScript (GetCombinedScriptRequest) returns (GetCombinedScriptResponse);
  rpc GetContext (GetContextRequest) returns (GetContextResponse);
  rpc CreateAndOpenWorkspace (CreateWorkspaceRequest) returns (CreateWorkspaceResponse);
  rpc GetScriptManifest (GetScriptManifestRequest) returns (GetScriptManifestResponse);
  rpc ValidateWorkingSet (ValidateWorkingSetRequest) returns (ValidateWorkingSetResponse);
  rpc ComputeParameterOptions (ComputeParameterOptionsRequest) returns (ComputeParameterOptionsResponse);
}

message CreateWorkspaceRequest {
  string script_path = 1;
  string script_type = 2;
}

message CreateWorkspaceResponse {
  string workspace_path = 1;
  string error_message = 2;
}

message ScriptFile {
  string file_name = 1;
  string content = 2;
}

message ExecuteScriptRequest {
  string script_content = 1;
  bytes parameters_json = 2;
  string source = 3;
}

message StructuredOutputItem {
  string type = 1;
  string data = 2; 
}

message ExecuteScriptResponse {
  bool is_success = 1;
  string output = 2;
  string error_message = 3;
  repeated string error_details = 4;
  repeated StructuredOutputItem structured_output = 5;
  string internal_data = 6;
  string agent_summary = 7;
}

message GetStatusRequest {
}

message GetStatusResponse {
  bool paracore_connected = 1;
  bool revit_open = 2;
  string revit_version = 3;
  bool document_open = 4;
  string document_title = 5;
  string document_type = 6;
}

message GetScriptMetadataRequest {
  repeated ScriptFile script_files = 1;
}

message GetScriptMetadataResponse {
  ScriptMetadata metadata = 1;
  string error_message = 2;
}

message GetScriptParametersRequest {
  repeated ScriptFile script_files = 1;
}

// Represents the metadata for a single script (single-file or multi-file).
// This is the new, finalized format.
message ScriptMetadata {
  string name = 1;                  // Name of the script (filename or folder name)
  string file_path = 2;             // Relative path from the agent workspace root
  string script_type = 3;           // "single-file" or "multi-file"
  string description = 4;
  string author = 5;
  repeated string categories = 6;
  repeated string dependencies = 7;
  string document_type = 8;
  repeated string usage_examples = 9;        // New field for usage examples
  string website = 10; 
  string last_run = 11;
}


message GetScriptParametersResponse {
  repeated ScriptParameter parameters = 1;
  string error_message = 2;
}

message ScriptParameter {
  string name = 1;
  string type = 2;
  string default_value_json = 3;
  string description = 4;
  repeated string options = 5;
  bool multi_select = 6;
  string visible_when = 7;
  
  // Enhanced Numeric Types
  string numeric_type = 8;  // "int" or "double"
  optional double min = 9;
  optional double max = 10;
  optional double step = 11;
  
  // Revit Element Selection
  bool is_revit_element = 12;
  string revit_element_type = 13;
  string revit_element_category = 14;
  bool requires_compute = 15;
  string group = 16;
  string input_type = 17;
  bool required = 18;
  string suffix = 19;
  string pattern = 20;
  string enabled_when_param = 21;
  string enabled_when_value = 22;
}

message GetCombinedScriptRequest {
  repeated ScriptFile script_files = 1;
  string script_path = 2; // Optional: Path to the script for context
}

message GetCombinedScriptResponse {
  string combined_script = 1;
  string error_message = 2;
}

message GetContextRequest {}

message GetContextResponse {
  string active_view_name = 1;
  int32 selection_count = 2;
  repeated int32 selected_element_ids = 3;
  ProjectInfo project_info = 4;
  string active_view_type = 5;
  int32 active_view_scale = 6;
  string active_view_detail_level = 7;
  repeated ElementInfo selected_elements = 8;
}

message ElementInfo {
  int32 id = 1;
  string category = 2;
}

message ProjectInfo {
  string name = 1;
  string number = 2;
  string title = 3;
  string file_path = 4;
  bool is_workshared = 5;
  string username = 6;
}

message GetScriptManifestRequest {
  string script_path = 1;
}

message GetScriptManifestResponse {
  string manifest_json = 1;
  string error_message = 2;
}

message ValidateWorkingSetRequest {
  repeated int64 element_ids = 1;
}

message ValidateWorkingSetResponse {
  repeated int64 valid_element_ids = 1;
}

message ComputeParameterOptionsRequest {
  string script_content = 1;
  string parameter_name = 2;
}

message ComputeParameterOptionsResponse {
  repeated string options = 1;
  bool is_success = 2;
  string error_message = 3;
}
